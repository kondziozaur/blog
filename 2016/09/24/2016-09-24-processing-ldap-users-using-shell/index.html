<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Delete LDAP users that do not match an attribute, using whitelist | Random Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="So you have a messy LDAP directory with tens of thousands users registered that don’t really belong to it. Each user has an accountId, and now you got your whitelist of accountIds that need to stay, a">
<meta property="og:type" content="article">
<meta property="og:title" content="Delete LDAP users that do not match an attribute, using whitelist">
<meta property="og:url" content="https://kondziozaur.github.io/blog/2016/09/24/2016-09-24-processing-ldap-users-using-shell/index.html">
<meta property="og:site_name" content="Random Notes">
<meta property="og:description" content="So you have a messy LDAP directory with tens of thousands users registered that don’t really belong to it. Each user has an accountId, and now you got your whitelist of accountIds that need to stay, a">
<meta property="og:updated_time" content="2016-09-25T06:32:49.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Delete LDAP users that do not match an attribute, using whitelist">
<meta name="twitter:description" content="So you have a messy LDAP directory with tens of thousands users registered that don’t really belong to it. Each user has an accountId, and now you got your whitelist of accountIds that need to stay, a">
  
    <link rel="alternate" href="/atom.xml" title="Random Notes" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/blog/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">Random Notes</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/blog/" id="subtitle">IT ramblings &amp; snippets</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://kondziozaur.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2016-09-24-processing-ldap-users-using-shell" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2016/09/24/2016-09-24-processing-ldap-users-using-shell/" class="article-date">
  <time datetime="2016-09-24T06:15:47.000Z" itemprop="datePublished">2016-09-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Delete LDAP users that do not match an attribute, using whitelist
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>So you have a messy LDAP directory with tens of thousands users registered that don’t really belong to it. Each user has an <em>accountId</em>, and now you got your <em>whitelist of accountIds</em> that need to stay, and all other users should be removed from the directory.</p>
<p>There is no direct ldapdelete way of doing it - you need to provide <em>dn</em>, not an attribute that has no match in your whitelist. So, how to proceed? Probably tens of solutions possible, but for my requirements this was the easiest:</p>
<ol>
<li>Export all users as csv file using any tool that can do it, e.g. <a href="http://directory.apache.org/studio/" target="_blank" rel="external">Apache Directory Studio</a> (list all attributes you want to fetch, for sure provide the accountId). Save in <code>people-ldap-export.csv</code></li>
<li>Have the whitelist of <em>accountIds</em> as another csv file, <code>accountWhiteList.csv</code></li>
<li><p>Create a whitelist csv file with your users:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xargs -I &#123;&#125; grep &quot;\&quot;&#123;&#125;\&quot;&quot; people-ldap-export.csv &lt; accountWhiteList.csv &gt; people-ldap-export-whitelist.csv</div></pre></td></tr></table></figure>
</li>
<li><p>Now that you have full list and whitelist, create a blacklist:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">diff people-ldap-export.csv people-ldap-export-whitelist.csv | grep &apos;&lt;&apos; | cut -c3- &gt; people-ldap-export-blacklist.csv</div></pre></td></tr></table></figure>
</li>
<li><p>And create a file for ldapdelete that has only list of blacklisted <em>dn</em>. (in my csv the dn was first field in quotes, hence I extract first string between <code>&quot;</code> characters.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed &apos;s/^&quot;\([^&quot;]*\).*/\1/&apos; &lt; people-ldap-export-blacklist.csv &gt; people-ldap-export-blacklist-dn.csv</div></pre></td></tr></table></figure>
</li>
<li><p>Now just delete the blacklisted dns:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ldapdelete -h myhost.company.com -D &quot;cn=Directory Manager&quot; -w password -p 389  &lt; people-ldap-export-blacklist-dn.csv</div></pre></td></tr></table></figure>
</li>
</ol>
<p>One importtant thing to consider: New user with new accountId can be created in your repo anytime, and you want to make sure he won’t be listed in the blacklist. Just make your user export first, then make sure that your accountId whitelist is up to date (was generated after you made the export). This way new users won’t be processed by the above steps at all, and won’t get deleted.</p>
<p>Refs:</p>
<ul>
<li><a href="http://unix.stackexchange.com/questions/110645/select-lines-from-text-file-which-have-ids-listed-in-another-file" target="_blank" rel="external">http://unix.stackexchange.com/questions/110645/select-lines-from-text-file-which-have-ids-listed-in-another-file</a></li>
<li><a href="http://www.grymoire.com/Unix/Sed.html" target="_blank" rel="external">http://www.grymoire.com/Unix/Sed.html</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kondziozaur.github.io/blog/blog/2016/09/24/2016-09-24-processing-ldap-users-using-shell/" data-id="citi90ozn0000nzi1gnuww265" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Apache-Directory-Studio/">Apache Directory Studio</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/csv/">csv</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/identity-management/">identity management</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/ldap/">ldap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/linux/">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/scripting/">scripting</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/shell/">shell</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/shell-is-my-spreadsheet/">shell is my spreadsheet</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/text-files/">text files</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/2016/09/25/hello-world/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Hello World
        
      </div>
    </a>
  
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Apache-Directory-Studio/">Apache Directory Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/csv/">csv</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/identity-management/">identity management</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/ldap/">ldap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/scripting/">scripting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/shell/">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/shell-is-my-spreadsheet/">shell is my spreadsheet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/text-files/">text files</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/Apache-Directory-Studio/" style="font-size: 10px;">Apache Directory Studio</a> <a href="/blog/tags/csv/" style="font-size: 10px;">csv</a> <a href="/blog/tags/identity-management/" style="font-size: 10px;">identity management</a> <a href="/blog/tags/ldap/" style="font-size: 10px;">ldap</a> <a href="/blog/tags/linux/" style="font-size: 10px;">linux</a> <a href="/blog/tags/scripting/" style="font-size: 10px;">scripting</a> <a href="/blog/tags/shell/" style="font-size: 10px;">shell</a> <a href="/blog/tags/shell-is-my-spreadsheet/" style="font-size: 10px;">shell is my spreadsheet</a> <a href="/blog/tags/text-files/" style="font-size: 10px;">text files</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/09/">September 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2016/09/25/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/blog/2016/09/24/2016-09-24-processing-ldap-users-using-shell/">Delete LDAP users that do not match an attribute, using whitelist</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Konrad Piotrowski<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>

  </div>
</body>
</html>